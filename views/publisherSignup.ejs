<%- include('./partials/header.ejs') %>

<form id="signupForm">
    <label for="email">Email address</label>
    <input type="text" name="email" required />
    <div class="email error"></div>

    <label for="password">Password</label>
    <input type="password" name="password" required />
    <div class="password error"></div>

    <label for="name">Name</label>
    <input type="text" name="name" required />

    <label for="creationYear">Creation Year</label>
    <input type="number" name="creationYear" required />
    <div class="creation-year error"></div> <!-- Add this div for errors -->

    <button id="signupButton">Sign up</button>
</form>

<div id="otpSection" style="display: none;">
    <label for="otp">Enter OTP</label>
    <input type="text" id="otpInput" name="otp" required />
    <button id="verifyOTPButton">Verify OTP</button>
    <div id="otpError" class="otp error" style="color: red; display: none;">Wrong OTP</div>
</div>

<script>
    const emailError = document.querySelector('.email.error');
    const passwordError = document.querySelector('.password.error');
    const creationYearError = document.querySelector('.creation-year.error'); // New error div
    const otpError = document.getElementById('otpError');
    const signupForm = document.getElementById('signupForm');
    const otpSection = document.getElementById('otpSection');

    signupForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        emailError.textContent = '';
        passwordError.textContent = '';
        creationYearError.textContent = ''; // Clear creation year error
        otpError.style.display = 'none';

        const formData = new FormData(signupForm);
        const values = Object.fromEntries(formData.entries());

        try {
            const response = await fetch('/auth/signup', {
                method: 'POST',
                body: JSON.stringify(values),
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();
            if (data.errors) {
                console.log(data.errors);
                emailError.textContent = data.errors.email;
                passwordError.textContent = data.errors.password;
                creationYearError.textContent = data.errors.creationYear; // Update creation year error
            } else if (data.case === 'otp') {
                otpSection.style.display = 'block';
                signupForm.style.display = 'none';
            } else if (data.case === 'success') {
                location.assign('/');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    });

    const verifyOTPButton = document.getElementById('verifyOTPButton');

    verifyOTPButton.addEventListener('click', async () => {
        const otpInput = document.getElementById('otpInput').value;

        try {
            const response = await fetch('/auth/otp', {
                method: 'POST',
                body: JSON.stringify({ otp: otpInput }),
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (data.case === 'success') {
                location.assign('/');
            } else if (data.case === 'wrong') {
                otpError.style.display = 'block';
            } else {
                console.log('OTP verification failed');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    });
</script>

<%- include('./partials/footer.ejs') %>
